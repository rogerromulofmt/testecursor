<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJe+R - Certid√£o em Lote</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }
        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea:focus, input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        .processos-input {
            height: 150px;
            resize: vertical;
        }
        .conteudo-input {
            height: 200px;
            resize: vertical;
        }
        .btn {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .progress {
            margin-top: 20px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #27ae60;
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
        }
        .resultados {
            margin-top: 20px;
            display: none;
        }
        .resultado-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .resultado-sucesso {
            background-color: #d5f4e6;
            border-left-color: #27ae60;
        }
        .resultado-erro {
            background-color: #fadbd8;
            border-left-color: #e74c3c;
        }
        .info {
            background-color: #d6eaf8;
            border: 1px solid #3498db;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info h3 {
            margin-top: 0;
            color: #2980b9;
        }
        .info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÑ Certid√£o em Lote - PJe+R</h1>
        
        <div class="info">
            <h3>‚ÑπÔ∏è Como usar:</h3>
            <ul>
                <li>Insira os n√∫meros dos processos (um por linha)</li>
                <li>Escolha o modelo de certid√£o</li>
                <li>Digite o conte√∫do da certid√£o (HTML permitido)</li>
                <li>Clique em "Adicionar Certid√£o em Lote"</li>
            </ul>
            <p><strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta funcionalidade adiciona apenas minutas de certid√£o. N√£o assina automaticamente.</p>
        </div>

        <form id="certidaoForm">
            <div class="form-group">
                <label for="processos">N√∫meros dos Processos (um por linha):</label>
                <textarea 
                    id="processos" 
                    class="processos-input" 
                    placeholder="Exemplo:&#10;0001234-12.2023.8.26.0100&#10;0005678-34.2023.8.26.0100&#10;0009012-56.2023.8.26.0100"
                    required
                ></textarea>
            </div>

            <div class="form-group">
                <label for="modelo">Modelo de Certid√£o:</label>
                <input 
                    type="text" 
                    id="modelo" 
                    value="CERTID√ÉO" 
                    placeholder="Ex: CERTID√ÉO, CERTID√ÉO DE TR√ÇNSITO EM JULGADO"
                    required
                >
            </div>

            <div class="form-group">
                <label for="conteudo">Conte√∫do da Certid√£o (HTML permitido):</label>
                <textarea 
                    id="conteudo" 
                    class="conteudo-input" 
                    placeholder="Digite o conte√∫do da certid√£o aqui...&#10;Exemplo:&#10;&lt;p&gt;Certifico que o processo encontra-se em tr√¢nsito em julgado.&lt;/p&gt;"
                    required
                ></textarea>
            </div>

            <div class="form-group">
                <button type="submit" class="btn" id="btnSubmit">üìÑ Adicionar Certid√£o em Lote</button>
                <button type="button" class="btn btn-danger" id="btnCancel" style="display: none;">‚ùå Cancelar</button>
            </div>
        </form>

        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Processando...</div>
        </div>

        <div class="resultados" id="resultados">
            <h3>üìä Resultados:</h3>
            <div id="resultadosLista"></div>
        </div>
    </div>

    <script>
        let isProcessing = false;
        let currentRequest = null;

        document.getElementById('certidaoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isProcessing) return;
            
            const processos = document.getElementById('processos').value
                .split('\n')
                .map(p => p.trim())
                .filter(p => p.length > 0);
            
            const modelo = document.getElementById('modelo').value.trim();
            const conteudo = document.getElementById('conteudo').value.trim();
            
            if (processos.length === 0) {
                alert('Por favor, insira pelo menos um n√∫mero de processo.');
                return;
            }
            
            if (!modelo || !conteudo) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            // Confirmar antes de prosseguir
            if (!confirm(`Deseja adicionar a certid√£o "${modelo}" em ${processos.length} processo(s)?`)) {
                return;
            }
            
            await processarCertidaoEmLote(processos, modelo, conteudo);
        });

        document.getElementById('btnCancel').addEventListener('click', function() {
            if (currentRequest) {
                currentRequest.abort();
            }
            resetarInterface();
        });

        async function processarCertidaoEmLote(processos, modelo, conteudo) {
            isProcessing = true;
            atualizarInterface(true);
            
            try {
                // Enviar mensagem para a extens√£o
                const mensagem = {
                    origem: 'PJEMaisR',
                    tipo: 'certidao',
                    mensagem: {
                        acao: 'incluirEmLote',
                        conteudo: {
                            processos: processos,
                            modeloCertidao: modelo,
                            conteudoCertidao: conteudo,
                            notificar: true
                        },
                        id: Date.now().toString()
                    }
                };
                
                // Enviar para o contexto da p√°gina
                window.postMessage(mensagem, window.location.origin);
                
                // Simular progresso (em uma implementa√ß√£o real, isso viria das notifica√ß√µes)
                simularProgresso(processos.length);
                
            } catch (erro) {
                console.error('Erro ao processar certid√£o em lote:', erro);
                mostrarResultado('Erro ao iniciar processamento: ' + erro.message, 'erro');
            } finally {
                isProcessing = false;
                atualizarInterface(false);
            }
        }

        function simularProgresso(total) {
            let atual = 0;
            const intervalo = setInterval(() => {
                atual++;
                const percentual = (atual / total) * 100;
                document.getElementById('progressFill').style.width = percentual + '%';
                document.getElementById('progressText').textContent = `Processando ${atual}/${total} processos...`;
                
                if (atual >= total) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('progressText').textContent = 'Conclu√≠do!';
                        mostrarResultado(`Processamento conclu√≠do para ${total} processos.`, 'sucesso');
                    }, 1000);
                }
            }, 2000); // Simular 2 segundos por processo
        }

        function atualizarInterface(processando) {
            const btnSubmit = document.getElementById('btnSubmit');
            const btnCancel = document.getElementById('btnCancel');
            const progress = document.getElementById('progress');
            
            if (processando) {
                btnSubmit.disabled = true;
                btnSubmit.textContent = '‚è≥ Processando...';
                btnCancel.style.display = 'inline-block';
                progress.style.display = 'block';
            } else {
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'üìÑ Adicionar Certid√£o em Lote';
                btnCancel.style.display = 'none';
            }
        }

        function resetarInterface() {
            isProcessing = false;
            atualizarInterface(false);
            document.getElementById('progress').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
        }

        function mostrarResultado(mensagem, tipo) {
            const resultados = document.getElementById('resultados');
            const resultadosLista = document.getElementById('resultadosLista');
            
            const item = document.createElement('div');
            item.className = `resultado-item resultado-${tipo}`;
            item.textContent = mensagem;
            
            resultadosLista.appendChild(item);
            resultados.style.display = 'block';
        }

        // Ouvir mensagens de resposta da extens√£o
        window.addEventListener('message', function(event) {
            if (event.data && event.data.origem === 'PJEMaisR' && event.data.tipo === 'certidoesResposta') {
                const { acao, conteudo } = event.data.mensagem;
                
                if (acao === 'incluirEmLote') {
                    const { total, sucessos, falhas, resultados } = conteudo;
                    
                    // Limpar resultados anteriores
                    document.getElementById('resultadosLista').innerHTML = '';
                    
                    // Mostrar resumo
                    mostrarResultado(`Lote conclu√≠do: ${sucessos} sucessos, ${falhas} falhas de ${total} processos.`, 
                                   sucessos > 0 ? 'sucesso' : 'erro');
                    
                    // Mostrar detalhes
                    resultados.forEach(resultado => {
                        const tipo = resultado.status === 'sucesso' ? 'sucesso' : 'erro';
                        const mensagem = resultado.status === 'sucesso' 
                            ? `Processo ${resultado.processo}: Certid√£o adicionada com sucesso`
                            : `Processo ${resultado.processo}: ${resultado.erro}`;
                        mostrarResultado(mensagem, tipo);
                    });
                }
            }
        });
    </script>
</body>
</html>

